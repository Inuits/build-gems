#!/bin/bash

set -x
export PATH="/usr/lib/ruby/gems/1.8/bin:$PATH"

target=${1-gem-list}

count=`cat $target | grep -v '^#' | wc -l`
cl=`echo $count | wc -c`
i=0;
[ -f failed.txt ] && rm failed.txt
[ -d BUILD ] || mkdir -p BUILD

while read gem
do
  let 'i++';
  echo $gem | grep -q ':' || gem="${gem}:"
  prefix=`printf "[%${cl}d/%d]" $i $count`
	version=`echo $gem    | cut -d':' -f 2 `
	basename=`echo $gem   | cut -d':' -f 1 `
  extra_args=`echo $gem | cut -d':' -f 3- `
	cd BUILD
	if [ x$version == 'x' ]; then
		echo "$prefix Building latest $basename"
#		eval fpm -t rpm -s gem -a noarch $extra_args $basename
		RETVAL=$?
	else
		echo "$prefix Building $basename version $version"
    extra_args="-v $version $extra_args"
#		fpm -t  rpm -s gem -v $version -a noarch $extra_args $basename
	fi
  eval fpm -t rpm -s gem -a noarch --gem-bin-path /usr/bin --prefix /usr/lib/ruby/gems/1.8 $extra_args $basename
  RETVAL=$?

	echo "$prefix Build of $basename returned with $RETVAL"
	if [  $RETVAL -ne 0 ]; then
    echo $basename >> ../failed.txt
  fi
	cd ../
done < <(cat $target | grep -v '^#')

if [ -d ARTIFACTS ]
then
    rm -rf ARTIFACTS
fi
mkdir ARTIFACTS
mv BUILD/*.rpm ARTIFACTS
rm -rf BUILD

if [ -f failed.txt ]; then
  errcount=`cat failed.txt | wc -l`
  if [ $errcount -gt 0 ]; then
    exit 1;
  fi;
fi;
